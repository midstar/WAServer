<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta charset="utf-8"/>
<html>
<head>
<title>Club distance</title>
<link rel="icon" type="image/x-icon" href="logo.ico">
<link rel="stylesheet" href="../was/was.css">
<script src="../was/was.js"></script>
<style>

body {
  margin: 0px;
  padding: 0px;
}

/********** Main page styles **********/

.head-content-footer {
  display: flex;
  flex-flow: column;
  height: 100%;
}

.header-container {
  font-size: 20px;
  margin: 2%;
  flex: 0 1 auto;
}

.body-container {
  flex: 1 1 auto;
}

.footer-container {
  flex: 0 1 70px;
}

.button {
  font-size: 25px;
  margin: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-width: 2px;
  border-radius: 10px;
  border-style: solid;
  user-select: none;
  cursor: pointer;
}


/********** Statictics page styles **********/

#statistics-header {
  display: flex;
  align-items: center;
  justify-content: center;
  padding-bottom: 5px;
}

#statistics-view {
  width: 90%;
  font-size: 25px;
  text-align: center; 
}

table {
  margin: auto;
  border: 1px solid black;
  border-collapse: collapse;
}

th, td {
  border: 1px solid black;
  padding-left: 5px;
  padding-right: 5px;
  font-size: 25px;
  text-align: center;
}

/********** Header styles **********/
#course-container {
  padding-bottom: 10px;
  display: flex;
}
#course-container select {
  font-size: 20px;
  flex-grow: 1;
}
#hole-ref-distance-container {
  display: flex;
  align-items: center;
}
#hole-container select {
  width: 70px;
  font-size: 35px;
  text-align: center;
}
#ref-distance {
  flex-grow: 1;
  font-size: 40px;
  text-align: center;
}
label {
  padding-right: 5px;
}

/********** Body club styles **********/
#club-container {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  width: 100%;
  height: 100%;
}
.club {
  font-size: 20px;
  width: 75px;
  height: 75px;
}
/********** Body club tracker styles **********/
#club-tracker-container {
  width: 100%;
  height: 100%;
}
#club-selected {
  font-size: 50px;
  text-align: center;
  margin-left: 20px;
}

#club-and-type {
  flex-grow: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
  cursor: pointer;
}

#club-distance {
  flex-grow: 1;
  font-size: 70px;
  text-align: center;
  margin-top: 30px;
}
#club-distance sub {
  font-size: 30px;
}
#club-distance sup {
  font-size: 30px;
}
#store-distance-button {
  height: 100px;
  font-size: 40px;
  margin-top: 30px;
}
#cancel-back-button {
  height: 80px;
  font-size: 30px;
  margin-top: 20px;
}

/********** Footer styles **********/

#stats-button {
  height: 55px;
}

/********** General dialog styles **********/

.dialog {
  z-index: 1;
  width: 90%;
  height:auto;
  /*height: 70%;*/
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-width: 4px;
  border-radius: 10px;
  border-style: solid;
}

/********** Swing dialog styles **********/

#swing-type-container {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  /*width: 90%;*/
  height: 100%;
  border-width: 3px;
  border-radius: 10px;
  border-style: dotted;
}

#swing-power-container {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  width: 100%;
  height: 100%;
}

#dialog-swing-type {
  display: none;
}

img {
  height: 100px;
}

.swing-button {
  font-size: 20px;
  text-align: center;
  margin: 5px;
  padding: 2px;
  width:70px;
  height: 130px;
  border-width: 2px;
  border-radius: 10px;
  border-style: solid;
  user-select: none;
  cursor: pointer;
}

.selected-type {
  background-color: rgb(206, 206, 253);
}

.selected-power {
  background-color: rgb(207, 248, 195);
}

#close-button {
  height: 55px;
}

/********** Manual input dialog styles **********/

#dialog-manual-input {
  display: none;
}

#manual-distance-container {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 40px;
  margin-bottom: 40px;
}

input {
  width: 90%
}

input[type='number'] { 
  font-size: 40px;
}

</style>
<script src="data.js"></script>
<script>

//////////////////////////////////////////////////////////////////////////////
// Startup

window.onload = async function() {
  await wasInit("Golf_distance", appPageCallback, "user", null);
}

function appPageCallback(gameName) {
  wasPageShow("page-app");
  updateAppPage();
}

//////////////////////////////////////////////////////////////////////////////
// App config

const GLOB_REF = { lat : undefined, long : undefined};
const GLOB_START = { timestamp : undefined, club : undefined,  
                     type: undefined, swing: undefined,
                     lat : undefined, long : undefined, altitude : undefined};
const GLOB_CURRENT = {lat : undefined, long : undefined, altitude : undefined,
                      dist: undefined};
const GLOB_STROKES = []; // Backup in case of offline

function updateAppPage() {
  // Hide club tracker
  document.getElementById("club-tracker-container").style.display = "none";
  
  // Fill in courses
  const elemCourse = document.getElementById("course");
  for (const course of Object.keys(data["course"])) {
    const elemOpt = document.createElement("option");
    elemOpt.setAttribute("value", course);
    elemOpt.innerText = course;
    elemCourse.appendChild(elemOpt);
  }
  
  // Fill in clubs
  const elemClub = document.getElementById("club-container");
  for (const club of data["club"]) {
    const elemDiv = document.createElement("div");
    elemDiv.setAttribute("class", "club button");
    elemDiv.setAttribute("onclick", `markStart("${club}")`);
    elemDiv.innerText = club;
    elemClub.appendChild(elemDiv);
  }
  
  // Configure and start geolocation tracking
  options = {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
  };
  navigator.geolocation.watchPosition(posUpdate, posError, options);

  // Check if stat page is selected
  if (wasGetUrlParam("page") == "page-statistics") {
    showStatistics();
  }
};

function changeCourse() {
  const course = document.getElementById("course").value;
  
  // Remove all holes
  const elemHole = document.getElementById("hole");
  elemHole.innerHTML = "";
  
  if (course in data["course"]) {
    // Fill in holes
    for (const hole of Object.keys(data["course"][course])) {
      const elemOpt = document.createElement("option");
      elemOpt.setAttribute("value", hole);
      elemOpt.innerText = hole;
      elemHole.appendChild(elemOpt);
    }
  }
  
  // Update reference position
  updateRef();
}

function updateRef() {
  const course = document.getElementById("course").value;
  
  if (course in data["course"]) {
    const hole = document.getElementById("hole").value;
    GLOB_REF.lat  = data["course"][course][hole][0];
    GLOB_REF.long = data["course"][course][hole][1];
  }
  
  updateDistances();
}

function markStart(club) {
  if (GLOB_CURRENT.lat != undefined) {
    document.getElementById("club-selected").innerHTML = club;
    GLOB_START.timestamp = Date.now();
    GLOB_START.club = club;
    GLOB_START.lat = GLOB_CURRENT.lat;
    GLOB_START.long = GLOB_CURRENT.long;
    GLOB_START.altitude = GLOB_CURRENT.altitude;
    updateDistances();
    selectSwingPower(100);
    selectSwingType("normal");
    showSwingDialog();
  }
}

async function markEnd(manualDist = 0) {
  var user = wasGetUrlParam("user");
  if (manualDist > 0) {
    GLOB_CURRENT.dist = manualDist;
  } else {
    GLOB_CURRENT.dist = calcDist(GLOB_CURRENT, GLOB_START);
  }
  const stroke = {
    "start": GLOB_START,
    "end" : GLOB_CURRENT,
    "course": document.getElementById("course").value,
    "hole" : document.getElementById("hole").value
  };

  GLOB_STROKES.push(stroke);

  for(var s of GLOB_STROKES) {
    const url = `${WAS_APP_URL}/dist/${user}/${GLOB_START.club}/${GLOB_START.timestamp}`;
    const request = new Request(url, {
      method: "POST",
      body: JSON.stringify(s),
    });
    try {
      const response = await fetch(request);
      if (!response.ok) {
        throw new Error(`Response status: ${response.status}`);
      }
    } catch (error) {
      console.error(error.message);
      // @TODO - add info about network error
    }
  }
  
  document.getElementById("club-container").style.display = "flex";
  document.getElementById("club-tracker-container").style.display = "none";
}

function markCancel() {
  document.getElementById("club-container").style.display = "flex";
  document.getElementById("club-tracker-container").style.display = "none";
}

//////////////////////////////////////////////////////////////////////////
// Geolocation stuff
function posUpdate(pos) {
  const crd = pos.coords;
  GLOB_CURRENT.lat = crd.latitude;
  GLOB_CURRENT.long = crd.longitude;
  GLOB_CURRENT.altitude = crd.altitude;
  
  updateDistances();
}

function posError(err) {
  document.getElementById("ref-distance").innerHTML = "ERR";
  document.getElementById("club-distance").innerHTML = "ERR";
  GLOB_CURRENT.lat = undefined;
  GLOB_CURRENT.long = undefined;
  GLOB_CURRENT.altitude = undefined;
  console.log(err);
}

function updateDistances() {
  if (GLOB_CURRENT.lat != undefined) {
    if (GLOB_REF.lat != undefined) {
      // Update distance to reference
      const refDist = calcDist(GLOB_CURRENT, GLOB_REF);
      document.getElementById("ref-distance").innerHTML = `${refDist} m`;
    }
    if (GLOB_START.lat != undefined) {
      // Update distance club start position
      const altDiff = Math.round(GLOB_CURRENT.altitude - GLOB_START.altitude);
      var altText = "";
      if (altDiff < 0) {
        altText = `<sub>&#8595;${Math.abs(altDiff)} m</sub>`
      } else {
        altText = `<sup>&#8593;${altDiff} m</sup>`
        
      }
      const clubDist = calcDist(GLOB_CURRENT, GLOB_START);
      document.getElementById("club-distance").innerHTML = `${clubDist} m ${altText}`;
      
    }
  }
}

function calcDist(pos1, pos2) {
  return calcCrow(pos1.lat, pos1.long, pos2.lat, pos2.long);
}

//This function takes in latitude and longitude of two location and returns the distance between them as the crow flies (in m)
function calcCrow(lat1, lon1, lat2, lon2) 
{
  var R = 6371000; // m
  var dLat = toRad(lat2-lat1);
  var dLon = toRad(lon2-lon1);
  var lat1 = toRad(lat1);
  var lat2 = toRad(lat2);
  
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
  Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  var d = R * c;
  return Math.round(d);
}

// Converts numeric degrees to radians
function toRad(Value) 
{
  return Value * Math.PI / 180;
}

//////////////////////////////////////////////////////////////////////////
// Statistics

async function showStatistics() {
  wasSetUrlParam("page", "page-statistics");
  wasPageShow("page-statistics");

  var view = document.getElementById("statistics-view").value;

  if (view == "normal" || view == "chip") {
    var table = `
      <table class="club-dist-table">
        <tr><th>Club</th><th>Min</th><th>Median</th><th>Max</th></tr>`;
    for (const club of data["club"]) {
      const strokes = await getStrokes(club);
      const dist = filterDistances(strokes,view,null)
      var min = "-";
      var median = "-";
      var max = "-";
      if (dist.length > 0) {
        min = dist[0];
        median = getMedian(dist);
        max = dist[dist.length - 1];
      }
      table += `<tr><td>${club}</td><td>${min}</td><td>${median}</td><td>${max}</td></tr>`;
    }
    table += `
      </table>`;
    
    document.getElementById("body-container-stat").innerHTML = table;
  } else {
    var swingType = "normal";
    if (view.includes("chip")) {
      swingType = "chip";
    }
    var table = `
      <table class="club-dist-table">
        <tr><th>Club</th><th>25%</th><th>50%</th><th>75%</th><th>100%</th></tr>`;
    for (const club of data["club"]) {
      const strokes = await getStrokes(club);
      var m = [];
      for(pow of [25,50,75,100]) {
        const dist = filterDistances(strokes,swingType,pow);
        if (dist.length > 0) {
          m.push(getMedian(dist));
        } else {
          m.push("-");
        }
      }
      table += `<tr><td>${club}</td><td>${m[0]}</td><td>${m[1]}</td><td>${m[2]}</td><td>${m[3]}</td></tr>`;
    }
    table += `
      </table>`;
    
    document.getElementById("body-container-stat").innerHTML = table;
  }
}

function getMedian(array) {
  if (array.length > 0) {
    min = array[0];
    max = array[array.length - 1];
    if (array.length == 1) {
      return array[0];
    } else {
      const middleIndex = Math.floor(array.length / 2);
      if (array.length % 2 === 0) {
          return Math.round((array[middleIndex - 1] + array[middleIndex]) / 2);
      } else {
          return array[middleIndex];
      }
    }
  }
  return 0;
}

function showApp() {
  wasSetUrlParam("page", "page-app");
  wasPageShow("page-app");
}

async function getStrokes(club) {
  var user = wasGetUrlParam("user");
  const result = [];
  const url = `${WAS_APP_URL}/dist/${user}/${club}/`;
  const response = await fetch(url);
  if (!response.ok) {
    console.log(response.status);
    return null;
  }
  const json = await response.json();
  return json;
}

// Distances are sorted from smallest to largest
function filterDistances(strokes, swingType, swingPower) {
  const result = [];
  if (strokes != null) {
    for (const stroke of Object.values(strokes)) {
      if ((swingType == null || swingType == stroke["start"].type) &&
          (swingPower == null || swingPower == stroke["start"].swing)) {
        result.push(stroke["end"].dist);
      }
    }
  }
  return result.sort(function (a, b) {  return a - b;  });  
}

//////////////////////////////////////////////////////////////////////////////
// Swing dialog

function showSwingDialog() {
  document.getElementById("dialog-swing-type").style.display = "flex";
}

function closeSwingDialog() {
  // Hide dialog
  document.getElementById("dialog-swing-type").style.display = "none";

  // Show distances
  document.getElementById("club-container").style.display = "none";
  document.getElementById("club-tracker-container").style.display = "block";

}

function selectSwingType(swingType) {
  var children = document.getElementById("swing-type-container").children;
  for (var child of children) {
    if (child.id == (swingType + "-swing")) {
      child.classList.add("selected-type");
    } else {
      child.classList.remove("selected-type");
    }
  }
  GLOB_START.type = swingType; 
}

function selectSwingPower(swingPower) {
  var children = document.getElementById("swing-power-container").children;
  for (var child of children) {
    if (child.id == ("pow-" + swingPower)) {
      child.classList.add("selected-power");
    } else {
      child.classList.remove("selected-power");
    }
  }
  document.getElementById("swing-power-img").src = swingPower + ".png";
  GLOB_START.swing = swingPower; 
}

//////////////////////////////////////////////////////////////////////////////
// Swing dialog

function storeManualDialog() {
  var manualDist = parseInt(document.getElementById("manual-distance").value);
  if (manualDist > 0) {
    closeManualDialog();
    markEnd(manualDist);
  }
}

function closeManualDialog() {
  document.getElementById("dialog-manual-input").style.display = "none";
}

function openManualDialog() {
  document.getElementById("dialog-manual-input").style.display = "flex";
  document.getElementById("manual-distance").value = "";
  document.getElementById("manual-distance").focus();
}




</script>
</head>
<body>
  <div id="page-app" class="was-page head-content-footer">
    <div class="header-container">
      <div id="course-container">
        <label for="course">Course:</label>
        <select name="course" id="course" onchange="changeCourse()">
          <option value="none"></option>
        </select>
      </div>
      <div id="hole-ref-distance-container">
        <div id="hole-container">
          <label for="hole">Hole:</label>
          <select name="hole" id="hole"  onchange="updateRef()">
          </select>
        </div>
        <div id="ref-distance">- m</div>
      </div>
      <hr>
    </div>
    <div class="body-container">
      <div id="club-container">
      </div>
      <div id="club-tracker-container">
        <div id="club-and-type" onclick="showSwingDialog()">
          <img id="swing-power-img" src="100.png"></img>
          <div id="club-selected">
          </div>
        </div>
        <div id="club-distance" onclick="openManualDialog()">- m</div>
        <div id="store-distance-button" class="button" onclick="markEnd()">Store distance</div>
        <div id="cancel-back-button" class="button" onclick="markCancel()">Cancel / Back</div>
      </div>
    </div>
    <div class="footer-container">
      <div id="stats-button" class="button" onclick="showStatistics()">Statistics</div>
    </div>
  </div>
  <div id="page-statistics" class="was-page head-content-footer">
    <div class="header-container" id="statistics-header">
      <select name="statistics-view" id="statistics-view" onchange="showStatistics()">
        <option value="normal">Normal min/med/max</option>
        <option value="normal-power">Normal power</option>
        <option value="chip">Chip min/med/max</option>
        <option value="chip-power">Chip power</option>
      </select>
    </div>
    <div class="body-container" id="body-container-stat">
    </div>
    <div class="footer-container">
      <div id="stats-button" class="button" onclick="showApp()">Back</div>
    </div>
  </div>
  <div id="dialog-swing-type" class="head-content-footer dialog">
    <div class="header-container">
      <div id="swing-type-container">
        <div id="normal-swing" class="club button selected-type" onclick="selectSwingType('normal')">Normal</div>
        <div id="chip-swing" class="club button" onclick="selectSwingType('chip')">Chip</div>
      </div>
    </div>
    <div class="body-container" id="body-container-stat">
      <div id="swing-power-container">
        <div id="pow-100" class="swing-button selected-power" onclick="selectSwingPower(100)">
          <div>100%</div>
          <img src="100.png"></img>
        </div>
        <div id="pow-75" class="swing-button" onclick="selectSwingPower(75)">
          <div>75%</div>
          <img src="75.png"></img>
        </div>
        <div id="pow-50" class="swing-button" onclick="selectSwingPower(50)">
          <div>50%</div>
          <img src="50.png"></img>
        </div>
        <div id="pow-25" class="swing-button" onclick="selectSwingPower(25)">
          <div>25%</div>
          <img src="25.png"></img>
        </div>
      </div>
    </div>
    <div class="footer-container">
      <div id="close-button" class="button" onclick="closeSwingDialog()">Ok</div>
    </div>
  </div>
  <div id="dialog-manual-input" class="head-content-footer dialog">
    <div class="header-container">
    </div>
    <div class="body-container" id="manual-distance-container">
      <input type="number" id="manual-distance" name="distance" onchange="storeManualDialog()">
    </div>
    <div class="footer-container">
      <div id="close-button" class="button" onclick="storeManualDialog()">Store</div>
      <div id="close-button" class="button" onclick="closeManualDialog()">Cancel</div>
    </div>
  </div>
</body>
</html>